<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0f172a;
    --bg-card: #1e293b;
    --bg-input: #0f172a;
    --accent: #38bdf8;
    --accent-glow: rgba(56, 189, 248, 0.15);
    --accent-dim: rgba(56, 189, 248, 0.6);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: #334155;
    --success: #34d399;
    --success-bg: rgba(52, 211, 153, 0.1);
    --danger: #f87171;
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans JP', -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }

  .app {
    max-width: 480px;
    margin: 0 auto;
    padding: 0 16px 100px;
  }

  .header {
    padding: 24px 0 8px;
    text-align: center;
    position: relative;
  }
  .header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: var(--accent);
    border-radius: 2px;
    opacity: 0.5;
  }
  .header h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--text-primary);
  }
  .header h1 span { color: var(--accent); }
  .header p {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .permission-banner {
    background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(251,146,60,0.1));
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    margin: 16px 0;
    display: none;
    align-items: center;
    gap: 12px;
    animation: fadeSlideIn 0.3s ease;
  }
  .permission-banner.show { display: flex; }
  .permission-banner .icon { font-size: 22px; flex-shrink: 0; }
  .permission-banner .info { flex: 1; }
  .permission-banner .info p { font-size: 13px; color: #fbbf24; font-weight: 500; }
  .permission-banner .info small { font-size: 11px; color: rgba(251,191,36,0.7); }
  .permission-banner button {
    background: #fbbf24;
    color: #0f172a;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    flex-shrink: 0;
    font-family: inherit;
  }

  .card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 20px;
    border: 1px solid var(--border);
    animation: fadeSlideIn 0.4s ease;
  }
  .card-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-label::before {
    content: '';
    width: 4px;
    height: 4px;
    background: var(--accent);
    border-radius: 50%;
  }

  .memo-area {
    width: 100%;
    min-height: 100px;
    background: var(--bg-input);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    font-size: 15px;
    color: var(--text-primary);
    resize: vertical;
    font-family: inherit;
    line-height: 1.6;
    transition: border-color 0.2s;
    outline: none;
  }
  .memo-area:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .memo-area::placeholder { color: var(--text-muted); }

  .time-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  .time-option { position: relative; }
  .time-option input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }
  .time-option label {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: var(--bg-input);
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    -webkit-user-select: none;
  }
  .time-option label:active { transform: scale(0.97); }
  .time-option input:checked + label {
    border-color: var(--accent);
    background: var(--accent-glow);
    box-shadow: 0 0 0 1px var(--accent-glow);
  }
  .checkbox-visual {
    width: 22px;
    height: 22px;
    border: 2px solid var(--text-muted);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .time-option input:checked + label .checkbox-visual {
    background: var(--accent);
    border-color: var(--accent);
  }
  .checkbox-visual svg {
    width: 14px;
    height: 14px;
    stroke: var(--bg-primary);
    stroke-width: 3;
    fill: none;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s;
  }
  .time-option input:checked + label .checkbox-visual svg {
    opacity: 1;
    transform: scale(1);
  }
  .time-label { display: flex; flex-direction: column; }
  .time-label .value {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
  }
  .time-label .desc {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 1px;
  }

  .submit-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--accent), #0ea5e9);
    color: var(--bg-primary);
    border: none;
    border-radius: var(--radius-sm);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    font-family: inherit;
    letter-spacing: 0.5px;
    margin-top: 20px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .submit-btn:active { transform: scale(0.98); opacity: 0.9; }
  .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--success);
    color: var(--bg-primary);
    padding: 14px 28px;
    border-radius: 50px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 8px 30px rgba(52, 211, 153, 0.3);
    z-index: 1000;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    pointer-events: none;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

  .reminder-list { margin-top: 20px; }
  .reminder-item {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    margin-bottom: 10px;
    animation: fadeSlideIn 0.3s ease;
    position: relative;
  }
  .reminder-item .memo-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 8px;
    word-break: break-word;
    line-height: 1.5;
    padding-right: 30px;
  }
  .reminder-tags { display: flex; flex-wrap: wrap; gap: 6px; }
  .reminder-tag {
    font-size: 11px;
    padding: 3px 10px;
    background: var(--accent-glow);
    color: var(--accent);
    border-radius: 20px;
    font-weight: 500;
  }
  .reminder-tag.done {
    background: var(--success-bg);
    color: var(--success);
    text-decoration: line-through;
    opacity: 0.6;
  }
  .reminder-tag.pending {
    position: relative;
  }
  .reminder-tag .countdown {
    font-size: 9px;
    opacity: 0.7;
    margin-left: 4px;
  }
  .reminder-delete {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    font-family: inherit;
  }
  .reminder-delete:active {
    background: rgba(248,113,113,0.1);
    color: var(--danger);
  }
  .reminder-time {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .empty-state {
    text-align: center;
    padding: 30px 20px;
    color: var(--text-muted);
    font-size: 13px;
    line-height: 1.8;
  }
  .empty-state .icon { font-size: 32px; margin-bottom: 8px; }

  /* status bar */
  .status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 0;
    font-size: 11px;
    color: var(--text-muted);
  }
  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  @keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>ğŸ”” <span>Remind</span>Me</h1>
    <p>ãƒ¡ãƒ¢ã—ã¦ã€å¿˜ã‚Œãªã„</p>
  </div>

  <div class="status-bar" id="statusBar" style="display:none">
    <div class="status-dot"></div>
    <span id="statusText">ç›£è¦–ä¸­: 0ä»¶ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</span>
  </div>

  <div class="permission-banner" id="permBanner">
    <div class="icon">âš ï¸</div>
    <div class="info">
      <p>é€šçŸ¥ã®è¨±å¯ãŒå¿…è¦ã§ã™</p>
      <small>ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹ãŸã‚ã«è¨±å¯ã—ã¦ãã ã•ã„</small>
    </div>
    <button onclick="requestPermission()">è¨±å¯ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="card-label">ãƒ¡ãƒ¢å†…å®¹</div>
    <textarea class="memo-area" id="memoInput" placeholder="ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›..."></textarea>
  </div>

  <div class="card">
    <div class="card-label">ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠ</div>
    <div class="time-grid">
      <div class="time-option">
        <input type="checkbox" id="t1" value="60000" data-label="1åˆ†å¾Œ">
        <label for="t1">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">1åˆ†å¾Œ</span><span class="desc">ã™ãç¢ºèª</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t2" value="180000" data-label="3åˆ†å¾Œ">
        <label for="t2">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">3åˆ†å¾Œ</span><span class="desc">ã¡ã‚‡ã£ã¨å¾Œã§</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t3" value="600000" data-label="10åˆ†å¾Œ">
        <label for="t3">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">10åˆ†å¾Œ</span><span class="desc">ä¼‘æ†©å¾Œã«</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t4" value="3600000" data-label="1æ™‚é–“å¾Œ">
        <label for="t4">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">1æ™‚é–“å¾Œ</span><span class="desc">ã²ã¨æ®µè½ã—ãŸã‚‰</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t5" value="7200000" data-label="2æ™‚é–“å¾Œ">
        <label for="t5">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">2æ™‚é–“å¾Œ</span><span class="desc">åˆå¾Œã®ã‚¿ã‚¹ã‚¯</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t6" value="86400000" data-label="1æ—¥å¾Œ">
        <label for="t6">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">1æ—¥å¾Œ</span><span class="desc">æ˜æ—¥ã‚„ã‚‹</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t7" value="259200000" data-label="3æ—¥å¾Œ">
        <label for="t7">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">3æ—¥å¾Œ</span><span class="desc">æ•°æ—¥å¾Œã«ç¢ºèª</span></div>
        </label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t8" value="604800000" data-label="1é€±é–“å¾Œ">
        <label for="t8">
          <div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>
          <div class="time-label"><span class="value">1é€±é–“å¾Œ</span><span class="desc">æ¥é€±ãƒ•ã‚©ãƒ­ãƒ¼</span></div>
        </label>
      </div>
    </div>
  </div>

  <button class="submit-btn" id="submitBtn" onclick="addReminder()">
    ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹
  </button>

  <div class="card" id="reminderSection" style="display:none;">
    <div class="card-label">è¨­å®šä¸­ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</div>
    <div id="reminderList"></div>
  </div>

  <div class="empty-state" id="emptyState">
    <div class="icon">ğŸ“</div>
    ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦<br>ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ==========================================================
  // ä¿®æ­£ç‰ˆ: setTimeout ã§ã¯ãªãã€Œãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ã€ã‚’æ¡ç”¨
  // - ã™ã¹ã¦ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’çµ¶å¯¾æ™‚åˆ»ã§ localStorage ã«ä¿å­˜
  // - 15ç§’ã”ã¨ã«ã€Œä»Šé€šçŸ¥ã™ã¹ãã‚‚ã®ãŒã‚ã‚‹ã‹ã€ã‚’ãƒã‚§ãƒƒã‚¯
  // - Service Worker ãŒåœæ­¢ã—ã¦ã‚‚ã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç”Ÿãã¦ã„ã‚Œã°é€šçŸ¥å¯èƒ½
  // - ä¸¡æ–¹ãŒå”èª¿ã—ã¦å‹•ä½œã™ã‚‹ãŸã‚ã€ä¿¡é ¼æ€§ãŒå¤§å¹…ã«å‘ä¸Š
  // ==========================================================

  let swRegistration = null;

  // ========== Service Worker ç™»éŒ² ==========
  async function registerSW() {
    if ('serviceWorker' in navigator) {
      try {
        swRegistration = await navigator.serviceWorker.register('sw.js');
        console.log('SW registered');

        // SW ã«ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ã‚’æŒ‡ç¤º
        navigator.serviceWorker.ready.then((reg) => {
          if (reg.active) {
            reg.active.postMessage({ type: 'START_POLLING' });
          }
        });

        // SW ã‹ã‚‰ã®ãƒã‚§ãƒƒã‚¯è¦æ±‚ã‚’å—ã‘å–ã‚‹
        navigator.serviceWorker.addEventListener('message', (event) => {
          if (event.data.type === 'CHECK_REMINDERS') {
            checkAndFireReminders();
          }
        });
      } catch (e) {
        console.log('SW registration failed:', e);
      }
    }
  }
  registerSW();

  // ========== é€šçŸ¥è¨±å¯ ==========
  function checkPermission() {
    const banner = document.getElementById('permBanner');
    if (!('Notification' in window)) {
      banner.classList.add('show');
      banner.querySelector('.info p').textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥éå¯¾å¿œã§ã™';
      banner.querySelector('button').style.display = 'none';
      return;
    }
    if (Notification.permission === 'default') {
      banner.classList.add('show');
    } else if (Notification.permission === 'denied') {
      banner.classList.add('show');
      banner.querySelector('.info p').textContent = 'é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™';
      banner.querySelector('.info small').textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„';
      banner.querySelector('button').style.display = 'none';
    } else {
      banner.classList.remove('show');
    }
  }

  async function requestPermission() {
    const result = await Notification.requestPermission();
    checkPermission();
    if (result === 'granted') {
      showToast('âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
    }
  }

  checkPermission();

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¿å­˜ ==========
  let reminders = JSON.parse(localStorage.getItem('reminders_v2') || '[]');

  function saveReminders() {
    localStorage.setItem('reminders_v2', JSON.stringify(reminders));
  }

  // ========== é€šçŸ¥ã‚’é€ä¿¡ ==========
  function fireNotification(tagId, memo, label) {
    if (Notification.permission !== 'granted') return;

    // Service Worker çµŒç”±ã§é€šçŸ¥ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚‚è¡¨ç¤ºå¯èƒ½ï¼‰
    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'SHOW_NOTIFICATION',
        payload: {
          id: tagId,
          title: 'ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰: ' + label,
          body: memo
        }
      });
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ç›´æ¥
      try {
        new Notification('ğŸ”” ãƒªãƒã‚¤ãƒ³ãƒ‰: ' + label, {
          body: memo,
          tag: tagId,
          vibrate: [200, 100, 200],
          requireInteraction: true
        });
      } catch (e) {
        console.log('Notification failed:', e);
      }
    }
  }

  // ========== ãƒãƒ¼ãƒªãƒ³ã‚°: é€šçŸ¥ã™ã¹ããƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ ==========
  function checkAndFireReminders() {
    const now = Date.now();
    let changed = false;

    for (const r of reminders) {
      for (const tag of r.tags) {
        // ã¾ã é€šçŸ¥ã—ã¦ã„ãªã„ & æ™‚åˆ»ãŒæ¥ãŸ
        if (!tag.fired && tag.fireAt <= now) {
          tag.fired = true;
          changed = true;
          fireNotification(tag.id, r.memo, tag.label);
          console.log('ğŸ”” Fired:', tag.label, r.memo);
        }
      }
    }

    if (changed) {
      saveReminders();
      renderReminders();
    }

    updateStatus();
  }

  // ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ==========
  function updateStatus() {
    const now = Date.now();
    let pendingCount = 0;
    for (const r of reminders) {
      for (const tag of r.tags) {
        if (!tag.fired && tag.fireAt > now) {
          pendingCount++;
        }
      }
    }

    const statusBar = document.getElementById('statusBar');
    const statusText = document.getElementById('statusText');
    if (pendingCount > 0) {
      statusBar.style.display = 'flex';
      statusText.textContent = 'ç›£è¦–ä¸­: ' + pendingCount + 'ä»¶ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼å¾…æ©Ÿä¸­';
    } else {
      statusBar.style.display = 'none';
    }
  }

  // ========== ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ15ç§’ã”ã¨ï¼‰ ==========
  setInterval(() => {
    checkAndFireReminders();
  }, 15000);

  // èµ·å‹•æ™‚ã«ã‚‚å³åº§ã«ãƒã‚§ãƒƒã‚¯
  checkAndFireReminders();

  // ========== Service Worker ã‚’èµ·ã“ã—ç¶šã‘ã‚‹ï¼ˆ20ç§’ã”ã¨ï¼‰ ==========
  setInterval(() => {
    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({ type: 'KEEP_ALIVE' });
    }
  }, 20000);

  // ========== ãƒšãƒ¼ã‚¸å¾©å¸°æ™‚ã«ã‚‚ãƒã‚§ãƒƒã‚¯ ==========
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      checkAndFireReminders();
    }
  });

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°æ™‚ã«ã‚‚ãƒã‚§ãƒƒã‚¯
  window.addEventListener('focus', () => {
    checkAndFireReminders();
  });

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¿½åŠ  ==========
  function addReminder() {
    const memo = document.getElementById('memoInput').value.trim();
    if (!memo) {
      showToast('âš ï¸ ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    const checkboxes = document.querySelectorAll('.time-option input:checked');
    if (checkboxes.length === 0) {
      showToast('âš ï¸ æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (Notification.permission !== 'granted') {
      requestPermission();
      return;
    }

    const reminderId = 'r_' + Date.now();
    const now = Date.now();
    const tags = [];

    checkboxes.forEach(cb => {
      const delay = parseInt(cb.value);
      const label = cb.dataset.label;
      const tagId = reminderId + '_' + delay;
      const fireAt = now + delay;

      tags.push({
        id: tagId,
        label: label,
        delay: delay,
        fireAt: fireAt,
        fired: false
      });
    });

    const reminder = {
      id: reminderId,
      memo: memo,
      createdAt: now,
      tags: tags
    };

    reminders.unshift(reminder);
    saveReminders();
    renderReminders();

    // ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('memoInput').value = '';
    checkboxes.forEach(cb => cb.checked = false);

    showToast('âœ… ' + tags.length + 'ä»¶ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ');

    // å³åº§ã«ãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†å¾Œã®ãƒªãƒã‚¤ãƒ³ãƒ‰ãªã©çŸ­ã„ã‚‚ã®ã«å‚™ãˆã‚‹ï¼‰
    // ã¾ãŸã€SW ã«ã‚‚ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ã‚’å†é€šçŸ¥
    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({ type: 'START_POLLING' });
    }
  }

  // ========== å‰Šé™¤ ==========
  function deleteReminder(id) {
    reminders = reminders.filter(r => r.id !== id);
    saveReminders();
    renderReminders();
    showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
  }

  // ========== æ®‹ã‚Šæ™‚é–“ã®è¡¨ç¤º ==========
  function formatRemaining(ms) {
    if (ms <= 0) return '';
    const sec = Math.floor(ms / 1000);
    if (sec < 60) return sec + 'ç§’';
    const min = Math.floor(sec / 60);
    if (min < 60) return min + 'åˆ†';
    const hr = Math.floor(min / 60);
    if (hr < 24) return hr + 'æ™‚é–“' + (min % 60 > 0 ? (min % 60) + 'åˆ†' : '');
    const day = Math.floor(hr / 24);
    return day + 'æ—¥' + (hr % 24 > 0 ? (hr % 24) + 'æ™‚é–“' : '');
  }

  // ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ==========
  function renderReminders() {
    const section = document.getElementById('reminderSection');
    const list = document.getElementById('reminderList');
    const empty = document.getElementById('emptyState');
    const now = Date.now();

    if (reminders.length === 0) {
      section.style.display = 'none';
      empty.style.display = 'block';
      updateStatus();
      return;
    }

    section.style.display = 'block';
    empty.style.display = 'none';

    list.innerHTML = reminders.map(r => {
      const date = new Date(r.createdAt);
      const timeStr = date.toLocaleString('ja-JP', {
        month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });

      const tagsHtml = r.tags.map(t => {
        const isFired = t.fired || now >= t.fireAt;
        const remaining = t.fireAt - now;
        const countdownText = (!isFired && remaining > 0) ? ' (' + formatRemaining(remaining) + ')' : '';

        return '<span class="reminder-tag ' + (isFired ? 'done' : 'pending') + '" data-tag-id="' + t.id + '">'
          + (isFired ? 'âœ“ ' : '')
          + t.label
          + (countdownText ? '<span class="countdown">' + countdownText + '</span>' : '')
          + '</span>';
      }).join('');

      return '<div class="reminder-item">'
        + '<button class="reminder-delete" onclick="deleteReminder(\'' + r.id + '\')">âœ•</button>'
        + '<div class="memo-text">' + escapeHtml(r.memo) + '</div>'
        + '<div class="reminder-tags">' + tagsHtml + '</div>'
        + '<div class="reminder-time">ä½œæˆ: ' + timeStr + '</div>'
        + '</div>';
    }).join('');

    updateStatus();
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
  setInterval(() => {
    renderReminders();
  }, 30000);

  // ========== èµ·å‹•æ™‚ã®å¾©å…ƒ ==========
  function restoreReminders() {
    const now = Date.now();
    let changed = false;

    // æ—¢ã«æ™‚åˆ»ãŒéãã¦ã„ã‚‹ã‚‚ã®ã‚’ fired ã«ãƒãƒ¼ã‚¯ï¼ˆé€šçŸ¥ã¯å†é€ã—ãªã„ï¼‰
    for (const r of reminders) {
      for (const t of r.tags) {
        if (!t.fired && t.fireAt <= now) {
          t.fired = true;
          changed = true;
          // èµ·å‹•ç›´å‰ã®ã‚‚ã®ã ã‘é€šçŸ¥ï¼ˆ5åˆ†ä»¥å†…ã«æœŸé™ã ã£ãŸã‚‚ã®ï¼‰
          if (now - t.fireAt < 5 * 60 * 1000) {
            fireNotification(t.id, r.memo, t.label);
          }
        }
      }
    }

    if (changed) saveReminders();
    renderReminders();
  }

  restoreReminders();

  // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }
</script>

</body>
</html>
