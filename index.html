<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f172a; --card: #1e293b; --input: #0f172a;
    --accent: #38bdf8; --glow: rgba(56,189,248,0.15);
    --text: #f1f5f9; --dim: #94a3b8; --muted: #64748b;
    --border: #334155; --success: #34d399; --warn: #fbbf24;
    --danger: #f87171; --radius: 16px; --sm: 10px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Noto Sans JP',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;-webkit-tap-highlight-color:transparent}
  .app{max-width:480px;margin:0 auto;padding:0 16px 120px}

  .header{padding:24px 0 8px;text-align:center;position:relative}
  .header::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:60px;height:3px;background:var(--accent);border-radius:2px;opacity:.5}
  .header h1{font-size:22px;font-weight:700}.header h1 span{color:var(--accent)}
  .header p{font-size:12px;color:var(--muted);margin-top:4px}

  .card{background:var(--card);border-radius:var(--radius);padding:20px;margin-top:20px;border:1px solid var(--border)}
  .card-label{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;display:flex;align-items:center;gap:6px}
  .card-label::before{content:'';width:4px;height:4px;background:var(--accent);border-radius:50%}

  /* Setup box */
  .setup-box{background:linear-gradient(135deg,rgba(56,189,248,.06),rgba(52,211,153,.04));border:1px solid rgba(56,189,248,.2);border-radius:var(--radius);padding:20px;margin-top:20px}
  .setup-title{font-size:15px;font-weight:700;color:var(--accent);margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .setup-step{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid var(--border)}
  .setup-step:last-child{border-bottom:none}
  .step-num{background:var(--accent);color:var(--bg);font-size:12px;font-weight:700;width:24px;height:24px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
  .step-text{font-size:13px;line-height:1.7}
  .step-text a{color:var(--accent);text-decoration:underline}

  .topic-display{display:flex;align-items:center;gap:8px;margin:12px 0;background:var(--bg);border:1.5px solid var(--border);border-radius:var(--sm);padding:10px 14px}
  .topic-display .label{font-size:11px;color:var(--muted);flex-shrink:0}
  .topic-display .value{font-size:14px;font-weight:600;color:var(--accent);flex:1;word-break:break-all;font-family:monospace}
  .topic-display .copy-btn{background:var(--accent);color:var(--bg);border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0;font-family:inherit}
  .topic-display .copy-btn:active{opacity:.7}

  .setup-status{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--sm);margin-top:12px;font-size:13px;font-weight:500}
  .setup-status.ok{background:rgba(52,211,153,.1);border:1px solid rgba(52,211,153,.25);color:var(--success)}
  .setup-status.pending{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.25);color:var(--warn)}

  /* Textarea */
  .memo-area{width:100%;min-height:100px;background:var(--input);border:1.5px solid var(--border);border-radius:var(--sm);padding:14px 16px;font-size:15px;color:var(--text);resize:vertical;font-family:inherit;line-height:1.6;outline:none;transition:border-color .2s}
  .memo-area:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
  .memo-area::placeholder{color:var(--muted)}

  /* Checkbox grid */
  .time-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .time-option{position:relative}
  .time-option input{position:absolute;opacity:0;width:0;height:0}
  .time-option label{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--input);border:1.5px solid var(--border);border-radius:var(--sm);cursor:pointer;transition:all .2s;user-select:none;-webkit-user-select:none}
  .time-option label:active{transform:scale(.97)}
  .time-option input:checked+label{border-color:var(--accent);background:var(--glow)}
  .cb{width:22px;height:22px;border:2px solid var(--muted);border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
  .time-option input:checked+label .cb{background:var(--accent);border-color:var(--accent)}
  .cb svg{width:14px;height:14px;stroke:var(--bg);stroke-width:3;fill:none;opacity:0;transform:scale(.5);transition:all .2s}
  .time-option input:checked+label .cb svg{opacity:1;transform:scale(1)}
  .tl{display:flex;flex-direction:column}
  .tl .v{font-size:14px;font-weight:500}
  .tl .d{font-size:10px;color:var(--muted);margin-top:1px}

  /* Summary option */
  .summary-option{margin-top:14px;padding-top:14px;border-top:1px solid var(--border)}
  .summary-option label{background:rgba(251,191,36,.04) !important;border-color:rgba(251,191,36,.2) !important}
  .summary-option input:checked+label{background:rgba(251,191,36,.1) !important;border-color:var(--warn) !important}
  .summary-option input:checked+label .cb{background:var(--warn);border-color:var(--warn)}
  .summary-option .v{color:var(--warn)}

  /* Button */
  .submit-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),#0ea5e9);color:var(--bg);border:none;border-radius:var(--sm);font-size:16px;font-weight:700;cursor:pointer;font-family:inherit;margin-top:20px;transition:all .2s;position:relative}
  .submit-btn:active{transform:scale(.98);opacity:.9}
  .submit-btn:disabled{opacity:.4;cursor:not-allowed}
  .submit-btn .spinner{display:none;width:18px;height:18px;border:3px solid rgba(15,23,42,.3);border-top-color:var(--bg);border-radius:50%;animation:spin .6s linear infinite;margin:0 auto}
  .submit-btn.loading .btn-text{display:none}
  .submit-btn.loading .spinner{display:block}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Toast */
  .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 28px;border-radius:16px;font-size:13px;font-weight:600;box-shadow:0 8px 30px rgba(0,0,0,.3);z-index:1000;opacity:0;transition:all .4s cubic-bezier(.175,.885,.32,1.275);pointer-events:none;max-width:90vw;text-align:center;line-height:1.5}
  .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
  .toast.success{background:var(--success);color:var(--bg)}
  .toast.error{background:var(--danger);color:#fff}
  .toast.warn{background:var(--warn);color:var(--bg)}

  /* Reminder list */
  .reminder-item{background:var(--input);border:1px solid var(--border);border-radius:var(--sm);padding:14px 16px;margin-bottom:10px;position:relative}
  .reminder-item .memo-text{font-size:14px;font-weight:500;margin-bottom:8px;word-break:break-word;line-height:1.5;padding-right:30px}
  .reminder-tags{display:flex;flex-wrap:wrap;gap:6px}
  .reminder-tag{font-size:11px;padding:3px 10px;border-radius:20px;font-weight:500}
  .reminder-tag.cloud{background:rgba(52,211,153,.1);color:var(--success)}
  .reminder-tag.local{background:var(--glow);color:var(--accent)}
  .reminder-tag.summary{background:rgba(251,191,36,.1);color:var(--warn)}
  .reminder-tag.relay{background:rgba(168,85,247,.1);color:#a855f7}
  .reminder-tag .icon{margin-right:3px}
  .reminder-delete{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:4px 8px;border-radius:6px;font-family:inherit}
  .reminder-delete:active{background:rgba(248,113,113,.1);color:var(--danger)}
  .reminder-time{font-size:10px;color:var(--muted);margin-top:6px}

  .empty-state{text-align:center;padding:30px 20px;color:var(--muted);font-size:13px;line-height:1.8}
  .empty-state .icon{font-size:32px;margin-bottom:8px}

  /* Info note */
  .info-note{font-size:11px;color:var(--muted);line-height:1.6;margin-top:8px;padding:8px 12px;background:rgba(100,116,139,.06);border-radius:8px}
  .info-note strong{color:var(--dim)}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <h1>ğŸ”” <span>Remind</span>Me</h1>
    <p>ã‚¯ãƒ©ã‚¦ãƒ‰é€šçŸ¥ã§ãƒ¡ãƒ¢ã‚’å¿˜ã‚Œãªã„</p>
  </div>

  <!-- ===== ntfy ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===== -->
  <div class="setup-box" id="setupBox">
    <div class="setup-title">â˜ï¸ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ1å›ã ã‘ï¼‰</div>

    <div class="setup-step">
      <div class="step-num">1</div>
      <div class="step-text">
        <a href="https://play.google.com/store/apps/details?id=io.heckel.ntfy" target="_blank">Google Play ã§ã€Œntfyã€ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</a>
        ï¼ˆç„¡æ–™ãƒ»åºƒå‘Šãªã—ï¼‰
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">2</div>
      <div class="step-text">ntfy ã‚¢ãƒ—ãƒªã‚’é–‹ãã€å³ä¸‹ã®ã€Œï¼‹ã€â†’ ä»¥ä¸‹ã®ãƒˆãƒ”ãƒƒã‚¯åã‚’å…¥åŠ›ã—ã¦è³¼èª­:</div>
    </div>

    <div class="topic-display">
      <span class="label">ãƒˆãƒ”ãƒƒã‚¯:</span>
      <span class="value" id="topicName"></span>
      <button class="copy-btn" onclick="copyTopic()">ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="setup-step">
      <div class="step-num">3</div>
      <div class="step-text">å®Œäº†ï¼ä»¥é™ã¯ã“ã®ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®šã™ã‚‹ã ã‘ã§ã€<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ ntfy ã‚¢ãƒ—ãƒªçµŒç”±ã§é€šçŸ¥</strong>ãŒå±Šãã¾ã™ã€‚</div>
    </div>

    <div class="setup-status pending" id="setupStatus">
      â³ ntfy ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button id="testBtn" style="background:var(--accent);color:var(--bg);border:none;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;flex:1;min-width:140px" onclick="testConnection()">ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
      <button style="background:rgba(52,211,153,.15);color:var(--success);border:1px solid rgba(52,211,153,.3);padding:10px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;flex:1;min-width:140px" onclick="confirmSetupDone()">âœ… è¨­å®šå®Œäº†ã—ãŸ</button>
    </div>
    <div id="testResult" style="margin-top:8px;font-size:12px;line-height:1.6;color:var(--muted);display:none"></div>
  </div>

  <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†å¾Œã®è¡¨ç¤º -->
  <div id="setupDoneBadge" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-top:16px;padding:10px 16px;background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.2);border-radius:var(--sm)">
      <span style="font-size:13px;color:var(--success);font-weight:500">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰é€šçŸ¥: ON</span>
      <button style="background:none;border:none;color:var(--muted);font-size:11px;cursor:pointer;font-family:inherit;text-decoration:underline" onclick="showSetup()">è¨­å®šã‚’è¦‹ã‚‹</button>
    </div>
  </div>

  <!-- ===== ãƒªãƒ¬ãƒ¼å¾…æ©ŸãƒãƒŠãƒ¼ ===== -->
  <div id="relayBanner" style="display:none;margin-top:12px;padding:12px 16px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.2);border-radius:var(--sm)">
    <div style="font-size:13px;color:#a855f7;font-weight:600">ğŸ”„ ãƒªãƒ¬ãƒ¼å¾…æ©Ÿä¸­: <span id="relayCount">0</span>ä»¶</div>
    <div style="font-size:11px;color:var(--muted);margin-top:2px">æ¬¡ã®ä¸­ç¶™: ç´„<span id="relayNext">-</span> ãƒ» ãƒªãƒ¬ãƒ¼é€šçŸ¥ãŒå±Šã„ãŸã‚‰ã“ã®ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„</div>
  </div>

  <!-- ===== ãƒ¡ãƒ¢å…¥åŠ› ===== -->
  <div class="card">
    <div class="card-label">ãƒ¡ãƒ¢å†…å®¹</div>
    <textarea class="memo-area" id="memoInput" placeholder="ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›..."></textarea>
  </div>

  <!-- ===== æ™‚åˆ»é¸æŠ ===== -->
  <div class="card">
    <div class="card-label">ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠ</div>
    <div class="time-grid">
      <div class="time-option"><input type="checkbox" id="t1" value="60" data-label="1åˆ†å¾Œ"><label for="t1"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">1åˆ†å¾Œ</span><span class="d">ã™ãç¢ºèª</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t2" value="180" data-label="3åˆ†å¾Œ"><label for="t2"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">3åˆ†å¾Œ</span><span class="d">ã¡ã‚‡ã£ã¨å¾Œã§</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t3" value="600" data-label="10åˆ†å¾Œ"><label for="t3"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">10åˆ†å¾Œ</span><span class="d">ä¼‘æ†©å¾Œã«</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t4" value="3600" data-label="1æ™‚é–“å¾Œ"><label for="t4"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">1æ™‚é–“å¾Œ</span><span class="d">ã²ã¨æ®µè½ã—ãŸã‚‰</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t5" value="7200" data-label="2æ™‚é–“å¾Œ"><label for="t5"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">2æ™‚é–“å¾Œ</span><span class="d">åˆå¾Œã®ã‚¿ã‚¹ã‚¯</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t6" value="86400" data-label="1æ—¥å¾Œ"><label for="t6"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">1æ—¥å¾Œ</span><span class="d">æ˜æ—¥ã‚„ã‚‹</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t7" value="259200" data-label="3æ—¥å¾Œ"><label for="t7"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">3æ—¥å¾Œ</span><span class="d">æ•°æ—¥å¾Œã«ç¢ºèª</span></div></label></div>
      <div class="time-option"><input type="checkbox" id="t8" value="604800" data-label="1é€±é–“å¾Œ"><label for="t8"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">1é€±é–“å¾Œ</span><span class="d">æ¥é€±ãƒ•ã‚©ãƒ­ãƒ¼</span></div></label></div>
    </div>

    <!-- ç¿Œæœã¾ã¨ã‚é€šçŸ¥ -->
    <div class="summary-option">
      <div class="time-option"><input type="checkbox" id="tSummary" checked><label for="tSummary"><div class="cb"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="tl"><span class="v">ç¿Œæœ 7:00 ã«ã¾ã¨ã‚é€šçŸ¥</span><span class="d">å‰æ—¥åˆ†ã®ãƒ¡ãƒ¢ã‚’ä¸€è¦§ã§é€šçŸ¥</span></div></label></div>
    </div>

    <div class="info-note">
      <strong>â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰é…ä¿¡:</strong> ntfy.sh ã‚µãƒ¼ãƒãƒ¼ãŒæ™‚é–“ç®¡ç†ã™ã‚‹ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™ã€‚<br>
      <strong>ğŸ”„ ãƒªãƒ¬ãƒ¼:</strong> 3æ—¥è¶…ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆ1é€±é–“å¾Œï¼‰ã¯è‡ªå‹•ãƒªãƒ¬ãƒ¼ã§å¯¾å¿œã€‚ä¸­ç¶™é€šçŸ¥ãŒå±Šã„ãŸã‚‰ã‚¢ãƒ—ãƒªã‚’1å›é–‹ãã ã‘ã§æ®‹ã‚ŠãŒå†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚
    </div>
  </div>

  <!-- ===== é€ä¿¡ãƒœã‚¿ãƒ³ ===== -->
  <button class="submit-btn" id="submitBtn" onclick="addReminder()">
    <span class="btn-text">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹</span>
    <div class="spinner"></div>
  </button>

  <!-- ===== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§ ===== -->
  <div class="card" id="reminderSection" style="display:none">
    <div class="card-label">è¨­å®šæ¸ˆã¿ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</div>
    <div id="reminderList"></div>
  </div>

  <div class="empty-state" id="emptyState">
    <div class="icon">ğŸ“</div>
    ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦<br>ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ==========================================================
  //  v4: ntfy.sh ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
  //
  //  ä»•çµ„ã¿:
  //  1. ntfy.sh ã« HTTP POST ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  //  2. Delay ãƒ˜ãƒƒãƒ€ãƒ¼ã§é…ä¿¡æ™‚åˆ»ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  //  3. ntfy.sh ã‚µãƒ¼ãƒãƒ¼ãŒæ™‚é–“ç®¡ç† â†’ ntfy ã‚¢ãƒ—ãƒªã« PUSH
  //  4. ãƒ–ãƒ©ã‚¦ã‚¶ä¸è¦ã€‚ã‚¹ãƒãƒ›ã®é›»æºã•ãˆå…¥ã£ã¦ã„ã‚Œã°å±Šã
  //
  //  ç¿Œæœã¾ã¨ã‚:
  //  - ãƒ¡ãƒ¢ä½œæˆæ™‚ã«ç¿Œæœ7:00é…ä¿¡ã®é€šçŸ¥ã‚‚åŒæ™‚ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  //  - åŒã˜æ—¥ã«è¤‡æ•°ãƒ¡ãƒ¢ â†’ æœ€å¾Œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå…¨ãƒ¡ãƒ¢ã‚’å«ã‚€
  // ==========================================================

  const NTFY_SERVER = 'https://ntfy.sh';

  // ========== ãƒˆãƒ”ãƒƒã‚¯ç®¡ç† ==========
  let ntfyTopic = localStorage.getItem('ntfy_topic_v4');
  if (!ntfyTopic) {
    // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒˆãƒ”ãƒƒã‚¯åã‚’ç”Ÿæˆï¼ˆæ¨æ¸¬å›°é›£ã«ã™ã‚‹ï¼‰
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let rand = '';
    for (let i = 0; i < 14; i++) rand += chars[Math.floor(Math.random() * chars.length)];
    ntfyTopic = 'remindme-' + rand;
    localStorage.setItem('ntfy_topic_v4', ntfyTopic);
  }
  document.getElementById('topicName').textContent = ntfyTopic;

  function copyTopic() {
    navigator.clipboard.writeText(ntfyTopic).then(() => {
      showToast('ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯åã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    }).catch(() => {
      // Fallback
      const el = document.createElement('textarea');
      el.value = ntfyTopic;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      showToast('ğŸ“‹ ãƒˆãƒ”ãƒƒã‚¯åã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
    });
  }

  // ========== ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—çŠ¶æ…‹ç®¡ç† ==========
  let setupDone = localStorage.getItem('ntfy_setup_done') === 'true';

  function confirmSetupDone() {
    setupDone = true;
    localStorage.setItem('ntfy_setup_done', 'true');
    updateSetupUI();
    showToast('âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼', 'success');
  }

  async function testConnection() {
    const btn = document.getElementById('testBtn');
    const result = document.getElementById('testResult');
    btn.disabled = true;
    btn.textContent = 'â³ ãƒ†ã‚¹ãƒˆä¸­...';
    result.style.display = 'block';
    result.innerHTML = 'é€ä¿¡ä¸­...';

    try {
      await sendNtfy('ğŸ§ª RemindMe æ¥ç¶šãƒ†ã‚¹ãƒˆ', 'ã“ã®é€šçŸ¥ãŒå±Šã„ã¦ã„ã‚Œã°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸã§ã™ï¼', 0);
      result.innerHTML = '<span style="color:var(--success)">âœ… é€ä¿¡æˆåŠŸï¼ ntfy ã‚¢ãƒ—ãƒªã«é€šçŸ¥ãŒå±Šã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>å±Šã„ã¦ã„ã‚Œã°è¨­å®šå®Œäº†ã§ã™ã€‚</span>';
      const status = document.getElementById('setupStatus');
      status.className = 'setup-status ok';
      status.textContent = 'âœ… ntfy.sh ã¸ã®é€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸ';
    } catch (e) {
      result.innerHTML = '<span style="color:var(--danger)">âŒ é€ä¿¡å¤±æ•—: ' + escForHtml(e.message) + '<br><br>'
        + 'è€ƒãˆã‚‰ã‚Œã‚‹åŸå› :<br>'
        + 'â€¢ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒãªã„<br>'
        + 'â€¢ GitHub Pagesï¼ˆHTTPSï¼‰ã§ã¯ãªã localhost ã§é–‹ã„ã¦ã„ã‚‹<br>'
        + 'â€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã®æ‹¡å¼µæ©Ÿèƒ½ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹</span>';
    }

    btn.disabled = false;
    btn.textContent = 'ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆ';
  }

  function escForHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function showSetup() {
    document.getElementById('setupBox').style.display = 'block';
    document.getElementById('setupDoneBadge').style.display = 'none';
  }

  function updateSetupUI() {
    if (setupDone) {
      document.getElementById('setupBox').style.display = 'none';
      document.getElementById('setupDoneBadge').style.display = 'block';
    } else {
      document.getElementById('setupBox').style.display = 'block';
      document.getElementById('setupDoneBadge').style.display = 'none';
    }
  }
  updateSetupUI();

  // ========== Service Worker (ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨) ==========
  let swReg = null;
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(r => { swReg = r; }).catch(() => {});
  }

  // ========== ntfy API (URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ–¹å¼) ==========
  // Content-Type: application/json ã¯ CORS ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆ(OPTIONS)ã‚’
  // èª˜ç™ºã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
  // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ–¹å¼ãªã‚‰ã€Œå˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€æ‰±ã„ã§ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆä¸è¦ã€‚
  async function sendNtfy(title, body, delaySec) {
    const params = new URLSearchParams();
    params.set('title', title);
    params.set('priority', '4');
    params.set('tags', 'bell');
    if (delaySec > 0) {
      params.set('delay', delaySec + 's');
    }

    const url = NTFY_SERVER + '/' + ntfyTopic + '?' + params.toString();

    const resp = await fetch(url, {
      method: 'POST',
      body: body   // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ = å˜ç´”ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆä¸è¦
    });

    if (!resp.ok) {
      const errText = await resp.text().catch(() => 'Unknown error');
      throw new Error(resp.status + ': ' + errText);
    }

    return await resp.json();
  }

  // ========== ç¿Œæœ7:00ã¾ã§ã®ç§’æ•°ã‚’è¨ˆç®— ==========
  function getSecondsUntilNext7am() {
    const now = new Date();
    const target = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 7, 0, 0);
    return Math.floor((target.getTime() - now.getTime()) / 1000);
  }

  // ========== ä»Šæ—¥ã®æ—¥ä»˜ã‚­ãƒ¼ ==========
  function getTodayKey() {
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }

  // ========== æœ¬æ—¥ã®ãƒ¡ãƒ¢è“„ç© (ã¾ã¨ã‚é€šçŸ¥ç”¨) ==========
  function getTodayMemos() {
    const key = 'daily_memos_' + getTodayKey();
    return JSON.parse(localStorage.getItem(key) || '[]');
  }

  function addTodayMemo(memo) {
    const key = 'daily_memos_' + getTodayKey();
    const memos = getTodayMemos();
    memos.push(memo);
    localStorage.setItem(key, JSON.stringify(memos));
    return memos;
  }

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ ==========
  let reminders = JSON.parse(localStorage.getItem('reminders_v4') || '[]');
  function saveReminders() { localStorage.setItem('reminders_v4', JSON.stringify(reminders)); }

  // ========== ãƒªãƒ¬ãƒ¼ã‚­ãƒ¥ãƒ¼ (3æ—¥è¶…ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ç”¨) ==========
  let relayQueue = JSON.parse(localStorage.getItem('relay_queue') || '[]');
  function saveRelays() { localStorage.setItem('relay_queue', JSON.stringify(relayQueue)); }

  const MAX_NTFY_DELAY = 250000; // ~2.9æ—¥ (å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ã‚’å–ã£ã¦259200ã‚ˆã‚Šå°‘ã—çŸ­ã)

  // 3æ—¥è¶…ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ãƒªãƒ¬ãƒ¼ã§å‡¦ç†
  async function scheduleWithRelay(tagId, label, memo, totalDelaySec) {
    if (totalDelaySec <= MAX_NTFY_DELAY) {
      // 3æ—¥ä»¥å†… â†’ ç›´æ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      await sendNtfy('ğŸ”” ' + label, memo, totalDelaySec);
      return 'cloud';
    }

    // 3æ—¥è¶… â†’ ãƒªãƒ¬ãƒ¼: ã¾ãš2.9æ—¥å¾Œã«ãƒªãƒ¬ãƒ¼é€šçŸ¥ã‚’é€ã‚‹
    const remainAfterRelay = totalDelaySec - MAX_NTFY_DELAY;
    const daysLeft = Math.ceil(remainAfterRelay / 86400);

    await sendNtfy(
      'ğŸ“¨ ãƒªãƒ¬ãƒ¼ä¸­ç¶™ (æ®‹ã‚Šç´„' + daysLeft + 'æ—¥)',
      'ã€Œ' + memo + 'ã€\n\nâ¬†ï¸ ã“ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã€RemindMeã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚',
      MAX_NTFY_DELAY
    );

    // ãƒªãƒ¬ãƒ¼ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜
    relayQueue.push({
      id: tagId,
      memo: memo,
      label: label,
      remainingSec: remainAfterRelay,
      relayFireAt: Date.now() + MAX_NTFY_DELAY * 1000,  // ãƒªãƒ¬ãƒ¼é€šçŸ¥ãŒå±Šãæ™‚åˆ»
      originalFireAt: Date.now() + totalDelaySec * 1000,
      status: 'waiting'  // waiting â†’ ready â†’ done
    });
    saveRelays();

    return 'relay';
  }

  // ========== ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚: ãƒªãƒ¬ãƒ¼ã®è‡ªå‹•å‡¦ç† ==========
  async function processRelays() {
    const now = Date.now();
    let processed = 0;
    let failed = 0;

    for (const relay of relayQueue) {
      if (relay.status === 'done') continue;

      // ãƒªãƒ¬ãƒ¼é€šçŸ¥ã®æ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      if (now >= relay.relayFireAt) {
        relay.status = 'ready';

        // æ®‹ã‚Šæ™‚é–“ã‚’å†è¨ˆç®— (ç›®æ¨™åˆ°ç€æ™‚åˆ» - ç¾åœ¨)
        const newRemaining = Math.max(0, Math.floor((relay.originalFireAt - now) / 1000));

        if (newRemaining <= 0) {
          // ã‚‚ã†æ™‚é–“ãŒéãã¦ã„ã‚‹ â†’ å³åº§ã«é€šçŸ¥
          try {
            await sendNtfy('ğŸ”” ' + relay.label, relay.memo, 0);
            relay.status = 'done';
            processed++;
          } catch (e) {
            failed++;
          }
        } else if (newRemaining <= MAX_NTFY_DELAY) {
          // æ®‹ã‚Š3æ—¥ä»¥å†… â†’ æœ€çµ‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
          try {
            await sendNtfy('ğŸ”” ' + relay.label, relay.memo, newRemaining);
            relay.status = 'done';
            processed++;
          } catch (e) {
            failed++;
          }
        } else {
          // ã¾ã 3æ—¥è¶… â†’ ã‚‚ã†1å›ãƒªãƒ¬ãƒ¼
          const nextRemain = newRemaining - MAX_NTFY_DELAY;
          const daysLeft = Math.ceil(nextRemain / 86400);
          try {
            await sendNtfy(
              'ğŸ“¨ ãƒªãƒ¬ãƒ¼ä¸­ç¶™ (æ®‹ã‚Šç´„' + daysLeft + 'æ—¥)',
              'ã€Œ' + relay.memo + 'ã€\n\nâ¬†ï¸ RemindMeã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„ã€‚è‡ªå‹•ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚',
              MAX_NTFY_DELAY
            );
            relay.relayFireAt = now + MAX_NTFY_DELAY * 1000;
            relay.remainingSec = nextRemain;
            relay.status = 'waiting';
            processed++;
          } catch (e) {
            failed++;
          }
        }
      }
    }

    // å®Œäº†ã—ãŸãƒªãƒ¬ãƒ¼ã‚’å‰Šé™¤
    relayQueue = relayQueue.filter(r => r.status !== 'done');
    saveRelays();

    if (processed > 0) {
      showToast('ğŸ”„ ' + processed + 'ä»¶ã®ãƒªãƒ¬ãƒ¼ã‚’è‡ªå‹•å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã—ãŸ', 'success');
      renderReminders();
    }
    if (failed > 0) {
      showToast('âš ï¸ ' + failed + 'ä»¶ã®ãƒªãƒ¬ãƒ¼å†é€ã«å¤±æ•—', 'error');
    }

    updateRelayBanner();
  }

  function updateRelayBanner() {
    const banner = document.getElementById('relayBanner');
    const pending = relayQueue.filter(r => r.status === 'waiting');
    if (pending.length > 0) {
      const nearest = Math.min(...pending.map(r => r.relayFireAt));
      const remain = nearest - Date.now();
      banner.style.display = 'block';
      document.getElementById('relayCount').textContent = pending.length;
      document.getElementById('relayNext').textContent = formatRem(remain);
    } else {
      banner.style.display = 'none';
    }
  }

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¿½åŠ  ==========
  async function addReminder() {
    const memo = document.getElementById('memoInput').value.trim();
    if (!memo) { showToast('âš ï¸ ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warn'); return; }

    const cbs = document.querySelectorAll('.time-grid .time-option input:checked');
    const summaryChecked = document.getElementById('tSummary').checked;

    if (cbs.length === 0 && !summaryChecked) {
      showToast('âš ï¸ æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warn');
      return;
    }

    const btn = document.getElementById('submitBtn');
    btn.classList.add('loading');
    btn.disabled = true;

    const id = 'r_' + Date.now();
    const now = Date.now();
    const tags = [];
    let allOk = true;
    let failedLabels = [];
    let relayCount = 0;

    // å€‹åˆ¥ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãƒªãƒ¬ãƒ¼å¯¾å¿œï¼‰
    for (const cb of cbs) {
      const delaySec = parseInt(cb.value);
      const label = cb.dataset.label;
      const tagId = id + '_' + delaySec;

      try {
        const type = await scheduleWithRelay(tagId, label, memo, delaySec);
        tags.push({ id: tagId, label, delaySec, fireAt: now + delaySec * 1000, type });
        if (type === 'relay') relayCount++;
      } catch (e) {
        console.error('Schedule failed for ' + label + ':', e);
        tags.push({ id: tagId, label, delaySec, fireAt: now + delaySec * 1000, type: 'failed', error: e.message });
        failedLabels.push(label + '(' + e.message + ')');
        allOk = false;
      }
    }

    // ç¿Œæœã¾ã¨ã‚é€šçŸ¥
    if (summaryChecked) {
      const allMemos = addTodayMemo(memo);
      const secTo7am = getSecondsUntilNext7am();

      const yd = new Date();
      const dateLabel = (yd.getMonth()+1) + 'æœˆ' + yd.getDate() + 'æ—¥';

      const summaryTitle = 'ğŸ“‹ ' + dateLabel + 'ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¾ã¨ã‚ï¼ˆ' + allMemos.length + 'ä»¶ï¼‰';
      const summaryBody = allMemos.map((m, i) => (i + 1) + '. ' + m).join('\n');

      try {
        await sendNtfy(summaryTitle, summaryBody, secTo7am);
        tags.push({ id: id + '_summary', label: 'ç¿Œæœ7:00ã¾ã¨ã‚', delaySec: secTo7am, fireAt: now + secTo7am * 1000, type: 'summary' });
      } catch (e) {
        console.error('ntfy summary failed:', e);
        tags.push({ id: id + '_summary', label: 'ç¿Œæœ7:00ã¾ã¨ã‚', delaySec: secTo7am, fireAt: now + secTo7am * 1000, type: 'failed' });
        allOk = false;
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
    if (tags.length > 0) {
      reminders.unshift({ id, memo, createdAt: now, tags });
      saveReminders();
      renderReminders();
    }

    // ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('memoInput').value = '';
    cbs.forEach(cb => cb.checked = false);

    btn.classList.remove('loading');
    btn.disabled = false;

    if (allOk) {
      let msg = 'âœ… ' + tags.length + 'ä»¶ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«';
      if (relayCount > 0) msg += 'ï¼ˆ' + relayCount + 'ä»¶ã¯ãƒªãƒ¬ãƒ¼çµŒç”±ï¼‰';
      showToast(msg, 'success');
    } else {
      showToast('âš ï¸ é€ä¿¡å¤±æ•—: ' + failedLabels.join(', '), 'error');
    }

    updateRelayBanner();
  }

  // ========== å‰Šé™¤ ==========
  function deleteReminder(id) {
    reminders = reminders.filter(r => r.id !== id);
    // ãƒªãƒ¬ãƒ¼ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã‚‚é–¢é€£ã‚’å‰Šé™¤
    relayQueue = relayQueue.filter(r => !r.id.startsWith(id));
    saveReminders();
    saveRelays();
    renderReminders();
    updateRelayBanner();
    showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ', 'warn');
  }

  // ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ==========
  function renderReminders() {
    const section = document.getElementById('reminderSection');
    const list = document.getElementById('reminderList');
    const empty = document.getElementById('emptyState');
    const now = Date.now();

    if (reminders.length === 0) {
      section.style.display = 'none';
      empty.style.display = 'block';
      return;
    }
    section.style.display = 'block';
    empty.style.display = 'none';

    list.innerHTML = reminders.map(r => {
      const ts = new Date(r.createdAt).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

      const tagsH = r.tags.map(t => {
        const past = now >= t.fireAt;
        let cls = 'cloud';
        let icon = 'â˜ï¸';
        if (t.type === 'relay') { cls = 'summary'; icon = 'ğŸ”„'; }
        if (t.type === 'summary') { cls = 'summary'; icon = 'ğŸ“‹'; }
        if (t.type === 'failed') { cls = 'cloud'; icon = 'âŒ'; }
        if (past && t.type !== 'failed') { icon = 'âœ…'; }
        if (t.type === 'relay' && !past) { icon = 'ğŸ”„'; }

        const remaining = t.fireAt - now;
        const cd = (!past && remaining > 0) ? ' (' + formatRem(remaining) + ')' : '';

        return '<span class="reminder-tag ' + cls + '"><span class="icon">' + icon + '</span>' + t.label + cd + '</span>';
      }).join('');

      return '<div class="reminder-item">'
        + '<button class="reminder-delete" onclick="deleteReminder(\'' + r.id + '\')">âœ•</button>'
        + '<div class="memo-text">' + esc(r.memo) + '</div>'
        + '<div class="reminder-tags">' + tagsH + '</div>'
        + '<div class="reminder-time">ä½œæˆ: ' + ts + '</div>'
        + '</div>';
    }).join('');
  }

  function formatRem(ms) {
    if (ms <= 0) return 'ã¾ã‚‚ãªã';
    const s = Math.floor(ms / 1000);
    if (s < 60) return s + 'ç§’';
    const m = Math.floor(s / 60);
    if (m < 60) return m + 'åˆ†';
    const h = Math.floor(m / 60);
    if (h < 24) return h + 'æ™‚é–“' + (m % 60 > 0 ? (m % 60) + 'åˆ†' : '');
    const d = Math.floor(h / 24);
    return d + 'æ—¥' + (h % 24 > 0 ? (h % 24) + 'æ™‚é–“' : '');
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ›´æ–° (30ç§’ã”ã¨)
  setInterval(renderReminders, 30000);

  // åˆæœŸè¡¨ç¤º
  renderReminders();

  // ========== èµ·å‹•æ™‚: ãƒªãƒ¬ãƒ¼ã®è‡ªå‹•å‡¦ç† ==========
  processRelays();
  updateRelayBanner();

  // ç”»é¢å¾©å¸°æ™‚ã«ã‚‚ãƒªãƒ¬ãƒ¼ãƒã‚§ãƒƒã‚¯
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      processRelays();
    }
  });
  window.addEventListener('focus', () => { processRelays(); });

  // ========== å¤ã„æ—¥åˆ¥ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— (3æ—¥ä»¥ä¸Šå‰) ==========
  (function cleanupOldDailyMemos() {
    const now = new Date();
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key && key.startsWith('daily_memos_')) {
        const dateStr = key.replace('daily_memos_', '');
        const d = new Date(dateStr);
        if (now - d > 3 * 24 * 60 * 60 * 1000) {
          localStorage.removeItem(key);
        }
      }
    }
  })();

  // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
  function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

  function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + type;
    t.classList.add('show');
    const dur = (type === 'error') ? 6000 : 3000;
    setTimeout(() => t.classList.remove('show'), dur);
  }
</script>
</body>
</html>
