<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0f172a;
    --bg-card: #1e293b;
    --bg-input: #0f172a;
    --accent: #38bdf8;
    --accent-glow: rgba(56,189,248,0.15);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: #334155;
    --success: #34d399;
    --success-bg: rgba(52,211,153,0.1);
    --danger: #f87171;
    --radius: 16px;
    --radius-sm: 10px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Noto Sans JP', -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100dvh;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  .app { max-width:480px; margin:0 auto; padding:0 16px 120px; }

  /* Header */
  .header { padding:24px 0 8px; text-align:center; position:relative; }
  .header::after { content:''; position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:60px; height:3px; background:var(--accent); border-radius:2px; opacity:0.5; }
  .header h1 { font-size:22px; font-weight:700; letter-spacing:0.5px; }
  .header h1 span { color:var(--accent); }
  .header p { font-size:12px; color:var(--text-muted); margin-top:4px; }

  /* Keep-alive banner */
  .keepalive-bar {
    margin:16px 0;
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    transition: all 0.3s;
  }
  .keepalive-bar.inactive {
    background: rgba(248,113,113,0.08);
    border: 1px solid rgba(248,113,113,0.25);
  }
  .keepalive-bar.active {
    background: rgba(52,211,153,0.08);
    border: 1px solid rgba(52,211,153,0.25);
  }
  .keepalive-info { flex:1; }
  .keepalive-info .title { font-size:13px; font-weight:600; }
  .keepalive-bar.inactive .title { color: var(--danger); }
  .keepalive-bar.active .title { color: var(--success); }
  .keepalive-info .desc { font-size:11px; color:var(--text-muted); margin-top:2px; }
  .keepalive-toggle {
    position: relative;
    width: 50px;
    height: 28px;
    flex-shrink: 0;
  }
  .keepalive-toggle input { opacity:0; width:0; height:0; position:absolute; }
  .keepalive-toggle .slider {
    position: absolute;
    cursor: pointer;
    top:0; left:0; right:0; bottom:0;
    background: #475569;
    border-radius: 28px;
    transition: 0.3s;
  }
  .keepalive-toggle .slider::before {
    content:'';
    position:absolute;
    width:22px; height:22px;
    left:3px; bottom:3px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
  }
  .keepalive-toggle input:checked + .slider { background: var(--success); }
  .keepalive-toggle input:checked + .slider::before { transform: translateX(22px); }

  /* Permission banner */
  .permission-banner {
    background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(251,146,60,0.1));
    border: 1px solid rgba(251,191,36,0.3);
    border-radius: var(--radius-sm);
    padding: 14px 16px;
    margin: 16px 0;
    display: none;
    align-items: center;
    gap: 12px;
  }
  .permission-banner.show { display:flex; }
  .permission-banner .icon { font-size:22px; flex-shrink:0; }
  .permission-banner .info { flex:1; }
  .permission-banner .info p { font-size:13px; color:#fbbf24; font-weight:500; }
  .permission-banner .info small { font-size:11px; color:rgba(251,191,36,0.7); }
  .permission-banner button {
    background:#fbbf24; color:#0f172a; border:none;
    padding:8px 16px; border-radius:8px;
    font-size:12px; font-weight:700; cursor:pointer; flex-shrink:0; font-family:inherit;
  }

  /* Card */
  .card {
    background: var(--bg-card);
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 20px;
    border: 1px solid var(--border);
  }
  .card-label {
    font-size:11px; font-weight:500; color:var(--text-muted);
    text-transform:uppercase; letter-spacing:1.5px; margin-bottom:12px;
    display:flex; align-items:center; gap:6px;
  }
  .card-label::before { content:''; width:4px; height:4px; background:var(--accent); border-radius:50%; }

  /* Textarea */
  .memo-area {
    width:100%; min-height:100px;
    background:var(--bg-input); border:1.5px solid var(--border);
    border-radius:var(--radius-sm); padding:14px 16px;
    font-size:15px; color:var(--text-primary); resize:vertical;
    font-family:inherit; line-height:1.6; transition:border-color 0.2s; outline:none;
  }
  .memo-area:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-glow); }
  .memo-area::placeholder { color:var(--text-muted); }

  /* Checkbox grid */
  .time-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
  .time-option { position:relative; }
  .time-option input { position:absolute; opacity:0; width:0; height:0; }
  .time-option label {
    display:flex; align-items:center; gap:10px;
    padding:12px 14px; background:var(--bg-input);
    border:1.5px solid var(--border); border-radius:var(--radius-sm);
    cursor:pointer; transition:all 0.2s; user-select:none; -webkit-user-select:none;
  }
  .time-option label:active { transform:scale(0.97); }
  .time-option input:checked + label {
    border-color:var(--accent); background:var(--accent-glow);
  }
  .checkbox-visual {
    width:22px; height:22px; border:2px solid var(--text-muted);
    border-radius:6px; display:flex; align-items:center; justify-content:center;
    transition:all 0.2s; flex-shrink:0;
  }
  .time-option input:checked + label .checkbox-visual {
    background:var(--accent); border-color:var(--accent);
  }
  .checkbox-visual svg {
    width:14px; height:14px; stroke:var(--bg-primary); stroke-width:3; fill:none;
    opacity:0; transform:scale(0.5); transition:all 0.2s;
  }
  .time-option input:checked + label .checkbox-visual svg { opacity:1; transform:scale(1); }
  .time-label { display:flex; flex-direction:column; }
  .time-label .value { font-size:14px; font-weight:500; }
  .time-label .desc { font-size:10px; color:var(--text-muted); margin-top:1px; }

  /* Button */
  .submit-btn {
    width:100%; padding:16px;
    background:linear-gradient(135deg,var(--accent),#0ea5e9);
    color:var(--bg-primary); border:none; border-radius:var(--radius-sm);
    font-size:16px; font-weight:700; cursor:pointer; font-family:inherit;
    letter-spacing:0.5px; margin-top:20px; transition:all 0.2s;
  }
  .submit-btn:active { transform:scale(0.98); opacity:0.9; }

  /* Toast */
  .toast {
    position:fixed; bottom:30px; left:50%;
    transform:translateX(-50%) translateY(100px);
    background:var(--success); color:var(--bg-primary);
    padding:14px 28px; border-radius:50px;
    font-size:14px; font-weight:600;
    box-shadow:0 8px 30px rgba(52,211,153,0.3);
    z-index:1000; opacity:0;
    transition:all 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
    pointer-events:none; white-space:nowrap;
  }
  .toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

  /* Reminder list */
  .reminder-item {
    background:var(--bg-input); border:1px solid var(--border);
    border-radius:var(--radius-sm); padding:14px 16px;
    margin-bottom:10px; position:relative;
  }
  .reminder-item .memo-text {
    font-size:14px; font-weight:500; margin-bottom:8px;
    word-break:break-word; line-height:1.5; padding-right:30px;
  }
  .reminder-tags { display:flex; flex-wrap:wrap; gap:6px; }
  .reminder-tag {
    font-size:11px; padding:3px 10px;
    background:var(--accent-glow); color:var(--accent);
    border-radius:20px; font-weight:500;
  }
  .reminder-tag.done {
    background:var(--success-bg); color:var(--success);
    text-decoration:line-through; opacity:0.6;
  }
  .reminder-tag .countdown { font-size:9px; opacity:0.7; margin-left:4px; }
  .reminder-delete {
    position:absolute; top:10px; right:10px;
    background:none; border:none; color:var(--text-muted);
    font-size:18px; cursor:pointer; padding:4px 8px;
    border-radius:6px; font-family:inherit;
  }
  .reminder-delete:active { background:rgba(248,113,113,0.1); color:var(--danger); }
  .reminder-time { font-size:10px; color:var(--text-muted); margin-top:6px; }

  .empty-state {
    text-align:center; padding:30px 20px;
    color:var(--text-muted); font-size:13px; line-height:1.8;
  }
  .empty-state .icon { font-size:32px; margin-bottom:8px; }

  .status-bar {
    display:flex; align-items:center; justify-content:center;
    gap:8px; padding:8px 0; font-size:11px; color:var(--text-muted);
  }
  .status-dot {
    width:6px; height:6px; border-radius:50%; background:var(--success);
    animation:pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  @keyframes fadeSlideIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>ğŸ”” <span>Remind</span>Me</h1>
    <p>ãƒ¡ãƒ¢ã—ã¦ã€å¿˜ã‚Œãªã„</p>
  </div>

  <!-- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶­æŒãƒˆã‚°ãƒ« -->
  <div class="keepalive-bar inactive" id="keepaliveBar">
    <div class="keepalive-info">
      <div class="title" id="keepaliveTitle">â¸ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œ: OFF</div>
      <div class="desc" id="keepaliveDesc">ONã«ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™</div>
    </div>
    <label class="keepalive-toggle">
      <input type="checkbox" id="keepaliveToggle" onchange="toggleKeepAlive()">
      <span class="slider"></span>
    </label>
  </div>

  <div class="status-bar" id="statusBar" style="display:none">
    <div class="status-dot"></div>
    <span id="statusText">ç›£è¦–ä¸­</span>
  </div>

  <div class="permission-banner" id="permBanner">
    <div class="icon">âš ï¸</div>
    <div class="info">
      <p>é€šçŸ¥ã®è¨±å¯ãŒå¿…è¦ã§ã™</p>
      <small>ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’å—ã‘å–ã‚‹ãŸã‚ã«è¨±å¯ã—ã¦ãã ã•ã„</small>
    </div>
    <button onclick="requestPermission()">è¨±å¯ã™ã‚‹</button>
  </div>

  <div class="card">
    <div class="card-label">ãƒ¡ãƒ¢å†…å®¹</div>
    <textarea class="memo-area" id="memoInput" placeholder="ãƒªãƒã‚¤ãƒ³ãƒ‰ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›..."></textarea>
  </div>

  <div class="card">
    <div class="card-label">ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠ</div>
    <div class="time-grid">
      <div class="time-option">
        <input type="checkbox" id="t1" value="60000" data-label="1åˆ†å¾Œ">
        <label for="t1"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">1åˆ†å¾Œ</span><span class="desc">ã™ãç¢ºèª</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t2" value="180000" data-label="3åˆ†å¾Œ">
        <label for="t2"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">3åˆ†å¾Œ</span><span class="desc">ã¡ã‚‡ã£ã¨å¾Œã§</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t3" value="600000" data-label="10åˆ†å¾Œ">
        <label for="t3"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">10åˆ†å¾Œ</span><span class="desc">ä¼‘æ†©å¾Œã«</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t4" value="3600000" data-label="1æ™‚é–“å¾Œ">
        <label for="t4"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">1æ™‚é–“å¾Œ</span><span class="desc">ã²ã¨æ®µè½ã—ãŸã‚‰</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t5" value="7200000" data-label="2æ™‚é–“å¾Œ">
        <label for="t5"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">2æ™‚é–“å¾Œ</span><span class="desc">åˆå¾Œã®ã‚¿ã‚¹ã‚¯</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t6" value="86400000" data-label="1æ—¥å¾Œ">
        <label for="t6"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">1æ—¥å¾Œ</span><span class="desc">æ˜æ—¥ã‚„ã‚‹</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t7" value="259200000" data-label="3æ—¥å¾Œ">
        <label for="t7"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">3æ—¥å¾Œ</span><span class="desc">æ•°æ—¥å¾Œã«ç¢ºèª</span></div></label>
      </div>
      <div class="time-option">
        <input type="checkbox" id="t8" value="604800000" data-label="1é€±é–“å¾Œ">
        <label for="t8"><div class="checkbox-visual"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="time-label"><span class="value">1é€±é–“å¾Œ</span><span class="desc">æ¥é€±ãƒ•ã‚©ãƒ­ãƒ¼</span></div></label>
      </div>
    </div>
  </div>

  <button class="submit-btn" onclick="addReminder()">ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’è¨­å®šã™ã‚‹</button>

  <div class="card" id="reminderSection" style="display:none;">
    <div class="card-label">è¨­å®šä¸­ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼</div>
    <div id="reminderList"></div>
  </div>

  <div class="empty-state" id="emptyState">
    <div class="icon">ğŸ“</div>
    ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦<br>ãƒªãƒã‚¤ãƒ³ãƒ‰æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ç„¡éŸ³ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶­æŒç”¨ -->
<audio id="keepAliveAudio" loop playsinline></audio>

<script>
  // ==========================================================
  // v3: ç„¡éŸ³ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶­æŒ + ãƒãƒ¼ãƒªãƒ³ã‚°
  //
  // å•é¡Œ: Android Chrome ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æ•°åç§’å¾Œã«
  //       ãƒšãƒ¼ã‚¸ã¨ Service Worker ã‚’åœæ­¢ã™ã‚‹
  // è§£æ±º: ç„¡éŸ³ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å†ç”Ÿã—ç¶šã‘ã‚‹ã“ã¨ã§ã€
  //       Chrome ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶­æŒã•ã‚Œã€
  //       ãƒ—ãƒ­ã‚»ã‚¹ãŒåœæ­¢ã•ã‚Œãªããªã‚‹
  // ==========================================================

  let swRegistration = null;
  let audioCtx = null;
  let keepAliveActive = false;

  // ========== ç„¡éŸ³ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®ç”Ÿæˆã¨å†ç”Ÿ ==========
  function createSilentAudio() {
    // WAVãƒ˜ãƒƒãƒ€ãƒ¼ + 1ç§’åˆ†ã®ç„¡éŸ³PCMãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    const sampleRate = 8000;
    const numSamples = sampleRate * 1; // 1ç§’
    const buffer = new ArrayBuffer(44 + numSamples * 2);
    const view = new DataView(buffer);

    // WAV header
    const writeStr = (offset, str) => { for(let i=0;i<str.length;i++) view.setUint8(offset+i, str.charCodeAt(i)); };
    writeStr(0, 'RIFF');
    view.setUint32(4, 36 + numSamples * 2, true);
    writeStr(8, 'WAVE');
    writeStr(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); // PCM
    view.setUint16(22, 1, true); // mono
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeStr(36, 'data');
    view.setUint32(40, numSamples * 2, true);
    // PCMãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦0 (ç„¡éŸ³)

    const blob = new Blob([buffer], { type: 'audio/wav' });
    return URL.createObjectURL(blob);
  }

  function startKeepAlive() {
    if (keepAliveActive) return;

    const audio = document.getElementById('keepAliveAudio');
    audio.src = createSilentAudio();
    audio.volume = 0.01; // ã»ã¼ç„¡éŸ³

    const playPromise = audio.play();
    if (playPromise) {
      playPromise.then(() => {
        keepAliveActive = true;
        updateKeepAliveUI();
        localStorage.setItem('keepalive', 'on');
        console.log('ğŸ”Š Keep-alive audio started');
      }).catch((e) => {
        console.log('Audio play failed:', e);
        showToast('âš ï¸ ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰å†åº¦ONã«ã—ã¦ãã ã•ã„');
      });
    }
  }

  function stopKeepAlive() {
    const audio = document.getElementById('keepAliveAudio');
    audio.pause();
    audio.src = '';
    keepAliveActive = false;
    updateKeepAliveUI();
    localStorage.setItem('keepalive', 'off');
    console.log('ğŸ”‡ Keep-alive audio stopped');
  }

  function toggleKeepAlive() {
    const toggle = document.getElementById('keepaliveToggle');
    if (toggle.checked) {
      startKeepAlive();
    } else {
      stopKeepAlive();
    }
  }

  function updateKeepAliveUI() {
    const bar = document.getElementById('keepaliveBar');
    const title = document.getElementById('keepaliveTitle');
    const desc = document.getElementById('keepaliveDesc');
    const toggle = document.getElementById('keepaliveToggle');

    if (keepAliveActive) {
      bar.className = 'keepalive-bar active';
      title.textContent = 'â–¶ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œ: ON';
      desc.textContent = 'ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»: æ¥µå°ï¼‰';
      toggle.checked = true;
    } else {
      bar.className = 'keepalive-bar inactive';
      title.textContent = 'â¸ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œ: OFF';
      desc.textContent = 'ONã«ã™ã‚‹ã¨ã‚¢ãƒ—ãƒªã‚’é–‰ã˜ã¦ã‚‚é€šçŸ¥ãŒå±Šãã¾ã™';
      toggle.checked = false;
    }
  }

  // ========== Service Worker ==========
  async function registerSW() {
    if ('serviceWorker' in navigator) {
      try {
        swRegistration = await navigator.serviceWorker.register('sw.js');
        console.log('SW registered');
      } catch (e) {
        console.log('SW registration failed:', e);
      }
    }
  }
  registerSW();

  // ========== é€šçŸ¥è¨±å¯ ==========
  function checkPermission() {
    const banner = document.getElementById('permBanner');
    if (!('Notification' in window)) {
      banner.classList.add('show');
      banner.querySelector('.info p').textContent = 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥éå¯¾å¿œã§ã™';
      banner.querySelector('button').style.display = 'none';
      return;
    }
    if (Notification.permission === 'default') {
      banner.classList.add('show');
    } else if (Notification.permission === 'denied') {
      banner.classList.add('show');
      banner.querySelector('.info p').textContent = 'é€šçŸ¥ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™';
      banner.querySelector('.info small').textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„';
      banner.querySelector('button').style.display = 'none';
    } else {
      banner.classList.remove('show');
    }
  }

  async function requestPermission() {
    const result = await Notification.requestPermission();
    checkPermission();
    if (result === 'granted') showToast('âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
  }
  checkPermission();

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ ==========
  let reminders = JSON.parse(localStorage.getItem('reminders_v3') || '[]');

  function saveReminders() {
    localStorage.setItem('reminders_v3', JSON.stringify(reminders));
  }

  // ========== é€šçŸ¥ç™ºç« ==========
  function fireNotification(tagId, memo, label) {
    if (Notification.permission !== 'granted') return;

    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'SHOW_NOTIFICATION',
        payload: { id: tagId, title: 'ğŸ”” ' + label, body: memo }
      });
    } else {
      try {
        new Notification('ğŸ”” ' + label, {
          body: memo, tag: tagId,
          vibrate: [200,100,200,100,200],
          requireInteraction: true
        });
      } catch(e) { console.log('Notification error:', e); }
    }
  }

  // ========== ãƒãƒ¼ãƒªãƒ³ã‚°: 10ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ ==========
  function checkAndFire() {
    const now = Date.now();
    let changed = false;

    for (const r of reminders) {
      for (const tag of r.tags) {
        if (!tag.fired && tag.fireAt <= now) {
          tag.fired = true;
          changed = true;
          fireNotification(tag.id, r.memo, tag.label);
        }
      }
    }

    if (changed) {
      saveReminders();
      renderReminders();
    }
    updateStatus();

    // ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒãƒªãƒ¼ã‚‚ãƒã‚§ãƒƒã‚¯
    checkDailySummary();
  }

  // ========== ãƒ‡ã‚¤ãƒªãƒ¼ã‚µãƒãƒªãƒ¼ï¼ˆæ¯æœ7æ™‚ã«å‰æ—¥åˆ†ã‚’ã¾ã¨ã‚ã¦é€šçŸ¥ï¼‰ ==========
  function checkDailySummary() {
    const now = new Date();
    const hour = now.getHours();
    const todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');

    // 7æ™‚ã‚ˆã‚Šå‰ãªã‚‰ä½•ã‚‚ã—ãªã„
    if (hour < 7) return;

    // ä»Šæ—¥ã™ã§ã«é€ä¿¡æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    const lastSent = localStorage.getItem('dailySummaryLastSent');
    if (lastSent === todayStr) return;

    // å‰æ—¥ã®0:00ã€œ23:59:59 ã®ç¯„å›²ã‚’è¨ˆç®—
    const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const yesterdayStart = todayMidnight - 24 * 60 * 60 * 1000;
    const yesterdayEnd = todayMidnight - 1;

    // å‰æ—¥ã«ä½œæˆã•ã‚ŒãŸãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’åé›†
    const yesterdayReminders = reminders.filter(r =>
      r.createdAt >= yesterdayStart && r.createdAt <= yesterdayEnd
    );

    // é€ä¿¡æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ï¼ˆå‰æ—¥åˆ†ãŒ0ä»¶ã§ã‚‚è¨˜éŒ²ã—ã¦å†ãƒã‚§ãƒƒã‚¯ã‚’é˜²ãï¼‰
    localStorage.setItem('dailySummaryLastSent', todayStr);

    if (yesterdayReminders.length === 0) return;

    // å‰æ—¥ã®æ—¥ä»˜è¡¨ç¤º
    const yd = new Date(yesterdayStart);
    const dateLabel = (yd.getMonth()+1) + 'æœˆ' + yd.getDate() + 'æ—¥';

    // ãƒ¡ãƒ¢ä¸€è¦§ã‚’çµ„ã¿ç«‹ã¦
    const memoList = yesterdayReminders.map((r, i) => {
      return (i+1) + '. ' + r.memo;
    }).join('\n');

    const title = 'ğŸ“‹ ' + dateLabel + 'ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ã¾ã¨ã‚ï¼ˆ' + yesterdayReminders.length + 'ä»¶ï¼‰';
    const body = memoList;

    // é€šçŸ¥ã‚’é€ä¿¡
    if (Notification.permission !== 'granted') return;

    if (swRegistration && swRegistration.active) {
      swRegistration.active.postMessage({
        type: 'SHOW_NOTIFICATION',
        payload: {
          id: 'daily_summary_' + todayStr,
          title: title,
          body: body
        }
      });
    } else {
      try {
        new Notification(title, {
          body: body,
          tag: 'daily_summary_' + todayStr,
          vibrate: [200,100,200,100,200],
          requireInteraction: true
        });
      } catch(e) { console.log('Daily summary notification error:', e); }
    }

    console.log('ğŸ“‹ Daily summary sent:', title);
  }

  // ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒªãƒ³ã‚° (10ç§’é–“éš”)
  setInterval(checkAndFire, 10000);

  // ç”»é¢å¾©å¸°æ™‚ã«å³ãƒã‚§ãƒƒã‚¯
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') checkAndFire();
  });
  window.addEventListener('focus', checkAndFire);

  // ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ==========
  function updateStatus() {
    const now = Date.now();
    let pending = 0;
    let nearest = Infinity;
    for (const r of reminders) {
      for (const t of r.tags) {
        if (!t.fired && t.fireAt > now) {
          pending++;
          nearest = Math.min(nearest, t.fireAt - now);
        }
      }
    }
    const bar = document.getElementById('statusBar');
    const text = document.getElementById('statusText');
    if (pending > 0) {
      bar.style.display = 'flex';
      text.textContent = pending + 'ä»¶å¾…æ©Ÿä¸­ ãƒ» æ¬¡: ' + formatRemaining(nearest);
    } else {
      bar.style.display = 'none';
    }
  }

  function formatRemaining(ms) {
    if (ms <= 0) return 'ã¾ã‚‚ãªã';
    const s = Math.floor(ms/1000);
    if (s < 60) return s + 'ç§’å¾Œ';
    const m = Math.floor(s/60);
    if (m < 60) return m + 'åˆ†å¾Œ';
    const h = Math.floor(m/60);
    if (h < 24) return h + 'æ™‚é–“' + (m%60 > 0 ? (m%60)+'åˆ†' : '') + 'å¾Œ';
    const d = Math.floor(h/24);
    return d + 'æ—¥å¾Œ';
  }

  // ========== ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¿½åŠ  ==========
  function addReminder() {
    const memo = document.getElementById('memoInput').value.trim();
    if (!memo) { showToast('âš ï¸ ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

    const cbs = document.querySelectorAll('.time-option input:checked');
    if (cbs.length === 0) { showToast('âš ï¸ æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    if (Notification.permission !== 'granted') { requestPermission(); return; }

    const id = 'r_' + Date.now();
    const now = Date.now();
    const tags = [];

    cbs.forEach(cb => {
      const delay = parseInt(cb.value);
      tags.push({
        id: id + '_' + delay,
        label: cb.dataset.label,
        delay: delay,
        fireAt: now + delay,
        fired: false
      });
    });

    reminders.unshift({ id, memo, createdAt: now, tags });
    saveReminders();
    renderReminders();

    document.getElementById('memoInput').value = '';
    cbs.forEach(cb => cb.checked = false);

    showToast('âœ… ' + tags.length + 'ä»¶ã®ãƒªãƒã‚¤ãƒ³ãƒ‰ã‚’è¨­å®š');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç¶­æŒãŒ OFF ãªã‚‰è‡ªå‹•ã§ ON ã«ã™ã‚‹
    if (!keepAliveActive) {
      document.getElementById('keepaliveToggle').checked = true;
      startKeepAlive();
      showToast('âœ… ' + tags.length + 'ä»¶è¨­å®š ãƒ» ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œON');
    }
  }

  function deleteReminder(id) {
    reminders = reminders.filter(r => r.id !== id);
    saveReminders();
    renderReminders();
    showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');

    // å¾…æ©Ÿä¸­ãŒ0ä»¶ãªã‚‰ keep-alive ã‚’æ­¢ã‚ã‚‹
    const now = Date.now();
    const hasPending = reminders.some(r => r.tags.some(t => !t.fired && t.fireAt > now));
    if (!hasPending && keepAliveActive) {
      document.getElementById('keepaliveToggle').checked = false;
      stopKeepAlive();
    }
  }

  // ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ==========
  function renderReminders() {
    const section = document.getElementById('reminderSection');
    const list = document.getElementById('reminderList');
    const empty = document.getElementById('emptyState');
    const now = Date.now();

    if (reminders.length === 0) {
      section.style.display = 'none';
      empty.style.display = 'block';
      updateStatus();
      return;
    }
    section.style.display = 'block';
    empty.style.display = 'none';

    list.innerHTML = reminders.map(r => {
      const ts = new Date(r.createdAt).toLocaleString('ja-JP',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
      const tagsH = r.tags.map(t => {
        const done = t.fired || now >= t.fireAt;
        const rem = t.fireAt - now;
        const cd = (!done && rem > 0) ? '<span class="countdown">(' + formatRemaining(rem) + ')</span>' : '';
        return '<span class="reminder-tag '+(done?'done':'')+'">'+(done?'âœ“ ':'')+t.label+cd+'</span>';
      }).join('');
      return '<div class="reminder-item">'
        +'<button class="reminder-delete" onclick="deleteReminder(\''+r.id+'\')">âœ•</button>'
        +'<div class="memo-text">'+escapeHtml(r.memo)+'</div>'
        +'<div class="reminder-tags">'+tagsH+'</div>'
        +'<div class="reminder-time">ä½œæˆ: '+ts+'</div>'
        +'</div>';
    }).join('');
    updateStatus();
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æ›´æ–° (30ç§’ã”ã¨)
  setInterval(renderReminders, 30000);

  // ========== èµ·å‹•æ™‚å¾©å…ƒ ==========
  (function restore() {
    const now = Date.now();
    let changed = false;
    for (const r of reminders) {
      for (const t of r.tags) {
        if (!t.fired && t.fireAt <= now) {
          t.fired = true;
          changed = true;
          // èµ·å‹•5åˆ†ä»¥å†…ã®ã‚‚ã®ã¯é€šçŸ¥
          if (now - t.fireAt < 5*60*1000) fireNotification(t.id, r.memo, t.label);
        }
      }
    }
    if (changed) saveReminders();
    renderReminders();

    // å‰å› keep-alive ON ã ã£ãŸã‚‰å¾©å¸°
    const hasPending = reminders.some(r => r.tags.some(t => !t.fired && t.fireAt > now));
    if (hasPending && localStorage.getItem('keepalive') === 'on') {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªã®ã§ã€ã‚¿ãƒƒãƒ—å¾…ã¡ã«ã™ã‚‹
      document.addEventListener('click', function resumeAudio() {
        startKeepAlive();
        document.removeEventListener('click', resumeAudio);
      }, { once: true });
      document.getElementById('keepaliveToggle').checked = true;
      const desc = document.getElementById('keepaliveDesc');
      desc.textContent = 'ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œã‚’å†é–‹ã—ã¾ã™';
    }
  })();

  // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
  function escapeHtml(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
  function showToast(msg) {
    const t=document.getElementById('toast'); t.textContent=msg;
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500);
  }
</script>
</body>
</html>
